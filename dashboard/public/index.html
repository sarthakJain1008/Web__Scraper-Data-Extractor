<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etsy Scraper - Real-Time Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold mb-4">Etsy Scraper Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Scraped Card -->
      <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center justify-center">
        <h2 class="text-lg font-semibold text-gray-500">Total Scraped</h2>
        <p id="total-listings" class="text-5xl font-bold text-blue-600">0</p>
      </div>

      <!-- Progress Chart Card -->
      <div class="bg-white p-6 rounded-lg shadow-md col-span-1 lg:col-span-2">
        <h2 class="text-lg font-semibold text-gray-500 mb-2">Overall Progress</h2>
        <canvas id="progress-chart"></canvas>
      </div>

      <!-- Data Quality Chart Card -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-500 mb-2">Data Quality</h2>
        <canvas id="quality-chart"></canvas>
      </div>
    </div>

    <h2 class="text-2xl font-bold mb-4">Recently Scraped Listings</h2>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <table class="w-full text-left">
        <thead>
          <tr>
            <th class="py-2">Title</th>
            <th class="py-2">Price</th>
            <th class="py-2">Tags</th>
          </tr>
        </thead>
        <tbody id="listings-table">
          <!-- Data will be inserted here by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const socket = io();

    const totalListingsEl = document.getElementById('total-listings');
    const listingsTableEl = document.getElementById('listings-table');

    let progressChart, qualityChart;

    socket.on('initial-data', (data) => {
      totalListingsEl.textContent = data.totalListings.toLocaleString();
      listingsTableEl.innerHTML = '';
      data.recentListings.forEach(addListingToTable);
      updateCharts(data.stats);
    });

    socket.on('stats-update', (data) => {
      totalListingsEl.textContent = data.totalListings.toLocaleString();
      updateCharts(data.stats);
    });

    socket.on('new-listing', (listing) => {
      addListingToTable(listing, true);
      const rows = listingsTableEl.getElementsByTagName('tr');
      if (rows.length > 10) {
        listingsTableEl.removeChild(rows[rows.length - 1]);
      }
    });

    function updateCharts(stats) {
      if (!progressChart) {
        const progressCtx = document.getElementById('progress-chart').getContext('2d');
        progressChart = new Chart(progressCtx, {
          type: 'doughnut',
          data: {
            labels: ['Scraped', 'Remaining'],
            datasets: [{
              data: [0, 1],
              backgroundColor: ['#3B82F6', '#E5E7EB'],
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      if (!qualityChart) {
        const qualityCtx = document.getElementById('quality-chart').getContext('2d');
        qualityChart = new Chart(qualityCtx, {
          type: 'bar',
          data: {
            labels: ['With Tags', 'With Materials', 'With Description'],
            datasets: [{
              label: '% of Scraped Listings',
              data: [0, 0, 0],
              backgroundColor: ['#10B981', '#F59E0B', '#8B5CF6'],
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
        });
      }

      progressChart.data.datasets[0].data = [stats.total, stats.totalListingsInDb - stats.total];
      progressChart.update();

      qualityChart.data.datasets[0].data = [
        (stats.withTags / stats.total) * 100,
        (stats.withMaterials / stats.total) * 100,
        (stats.withDescription / stats.total) * 100
      ];
      qualityChart.update();
    }

    function addListingToTable(listing, isNew = false) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="py-2"><a href="${listing.url}" target="_blank" class="text-blue-600 hover:underline">${listing.title}</a></td>
        <td class="py-2">${listing.price?.formatted_short || 'N/A'}</td>
        <td class="py-2">${(listing.tags || []).slice(0, 3).join(', ')}</td>
      `;
      if (isNew) {
        row.classList.add('bg-green-100');
        listingsTableEl.prepend(row);
      } else {
        listingsTableEl.appendChild(row);
      }
    }
  </script>
</body>
</html>
